<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kartu Kontrol Harian PBJT Makanan & Minuman</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
            .card { box-shadow: none !important; border: 1px solid #e5e7eb !important; }
        }
        .print-only { display: none; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; background: #eff6ff; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 via-blue-700 to-blue-500 no-print">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-blue-100 text-blue-700 rounded-xl p-3">
                    <i class="fas fa-user-shield text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Login Petugas</h1>
                    <p class="text-sm text-gray-500">Kartu Kontrol Harian PBJT</p>
                </div>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="login-username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Masukkan username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Masukkan password">
                </div>
                <p id="login-error" class="text-sm text-red-600 hidden">Username atau password salah.</p>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                    <i class="fas fa-sign-in-alt"></i> Masuk
                </button>
            </form>
        </div>
    </div>

    <div id="app-content" class="hidden">
    <header class="gradient-bg text-white shadow-lg no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-clipboard-check text-3xl"></i>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold">Kartu Kontrol Harian PBJT</h1>
                        <p class="text-blue-200 text-sm">Pemungutan & Penagihan Pajak Makanan/Minuman</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="bg-green-500 hover:bg-green-600 px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition">
                        <i class="fas fa-download"></i> <span class="hidden md:inline">Export</span>
                    </button>
                    <button onclick="window.print()" class="bg-white text-blue-800 hover:bg-blue-50 px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition">
                        <i class="fas fa-print"></i> <span class="hidden md:inline">Cetak</span>
                    </button>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition">
                        <i class="fas fa-sign-out-alt"></i> <span class="hidden md:inline">Keluar</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-sm no-print">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto">
                <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-btn tab-active px-4 py-3 font-medium text-sm whitespace-nowrap flex items-center gap-2 transition">
                    <i class="fas fa-chart-pie"></i> Dashboard Harian
                </button>
                <button onclick="showTab('input')" id="tab-input" class="tab-btn px-4 py-3 font-medium text-sm whitespace-nowrap flex items-center gap-2 text-gray-600 hover:bg-gray-50 transition">
                    <i class="fas fa-plus-circle"></i> Input Kartu Harian
                </button>
                <button onclick="showTab('daftar')" id="tab-daftar" class="tab-btn px-4 py-3 font-medium text-sm whitespace-nowrap flex items-center gap-2 text-gray-600 hover:bg-gray-50 transition">
                    <i class="fas fa-list"></i> Daftar Kunjungan
                </button>
                <button onclick="showTab('wajib-pajak')" id="tab-wajib-pajak" class="tab-btn px-4 py-3 font-medium text-sm whitespace-nowrap flex items-center gap-2 text-gray-600 hover:bg-gray-50 transition">
                    <i class="fas fa-building"></i> Data Wajib Pajak
                </button>
                <button onclick="showTab('laporan')" id="tab-laporan" class="tab-btn px-4 py-3 font-medium text-sm whitespace-nowrap flex items-center gap-2 text-gray-600 hover:bg-gray-50 transition">
                    <i class="fas fa-chart-bar"></i> Laporan Harian
                </button>
                <button onclick="showTab('pengaturan')" id="tab-pengaturan" class="tab-btn px-4 py-3 font-medium text-sm whitespace-nowrap flex items-center gap-2 text-gray-600 hover:bg-gray-50 transition">
                    <i class="fas fa-cog"></i> Pengaturan
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-6">
        <div id="content-dashboard" class="tab-content">
            <div class="bg-white rounded-xl shadow-md p-6 mb-6 card-hover transition">
                <div class="flex items-center gap-2 mb-4">
                    <i class="fas fa-user-shield text-blue-600"></i>
                    <h2 class="text-lg font-bold text-gray-800">Informasi Petugas & Wilayah</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="collector-info"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Tagihan Hari Ini</p>
                            <p class="text-2xl font-bold text-gray-800" id="summary-today">Rp 0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total PBJT Tertagih</p>
                            <p class="text-2xl font-bold text-green-600" id="summary-paid">Rp 0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-coins text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Jumlah Kunjungan</p>
                            <p class="text-2xl font-bold text-purple-600" id="summary-visits">0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-map-marked-alt text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Outstanding Hari Ini</p>
                            <p class="text-2xl font-bold text-orange-600" id="summary-outstanding">Rp 0</p>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-full">
                            <i class="fas fa-exclamation-circle text-orange-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 card-hover transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Jumlah Petugas</p>
                            <p class="text-2xl font-bold text-blue-700" id="summary-petugas">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-line text-blue-600"></i> Tren 7 Hari Terakhir
                    </h3>
                    <div id="chart-container" class="h-64 flex items-end justify-around gap-2"></div>
                    <div class="flex justify-around mt-2 text-xs text-gray-500" id="chart-labels"></div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-clock text-blue-600"></i> Kunjungan Terbaru
                    </h3>
                    <div id="recent-visits" class="space-y-3 max-h-64 overflow-y-auto">
                        <p class="text-gray-400 text-center py-8">Belum ada data kunjungan</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-input" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-md p-6 max-w-5xl mx-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fas fa-pen-to-square text-blue-600"></i> Input Kartu Kontrol Harian
                </h2>
                <form id="daily-form" class="space-y-6">
                    <input type="hidden" id="edit-id" value="">

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Kunjungan *</label>
                            <input type="date" id="tanggal" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Petugas *</label>
                            <input type="text" id="petugas" list="petugas-list" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nama petugas">
                            <datalist id="petugas-list"></datalist>
                            <button type="button" onclick="showTab('pengaturan'); scrollToSection('petugas-section')" class="text-xs text-blue-600 mt-2 hover:underline">Kelola data petugas</button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Shift *</label>
                            <select id="shift" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="Pagi">Pagi</option>
                                <option value="Siang">Siang</option>
                                <option value="Sore">Sore</option>
                                <option value="Malam">Malam</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Wajib Pajak Terdaftar</label>
                            <select id="wp-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">Pilih Wajib Pajak (opsional)</option>
                            </select>
                            <button type="button" onclick="showTab('wajib-pajak')" class="text-xs text-blue-600 mt-2 hover:underline">Kelola data Wajib Pajak</button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Wilayah/Area *</label>
                            <input type="text" id="wilayah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Contoh: Kecamatan X">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Usaha/WP *</label>
                            <input type="text" id="nama-usaha" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nama usaha">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NPWPD/NPWP</label>
                            <input type="text" id="npwp" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nomor NPWPD/NPWP">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">No. Ketetapan/Bukti *</label>
                            <input type="text" id="no-bukti" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Contoh: SKPD/001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pajak *</label>
                            <select id="jenis" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="makanan">Makanan</option>
                                <option value="minuman">Minuman</option>
                                <option value="makanan_minuman">Makanan & Minuman</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran</label>
                            <select id="metode" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="Tunai">Tunai</option>
                                <option value="Non Tunai">Non Tunai</option>
                                <option value="Transfer">Transfer</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">DPP *</label>
                            <input type="number" id="dpp" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="0" min="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tarif PBJT (%) *</label>
                            <select id="tarif" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">PBJT Terutang</label>
                            <input type="text" id="pbjt" readonly class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg font-bold text-green-600" value="Rp 0">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status Kunjungan</label>
                            <select id="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="tertagih">Tertagih</option>
                                <option value="pending">Pending</option>
                                <option value="tidak_ditemui">Tidak Ditemui</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                            <textarea id="keterangan" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Catatan hasil kunjungan"></textarea>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Foto Pelaksanaan Penagihan</label>
                            <div class="flex flex-col gap-2">
                                <button type="button" onclick="openCamera()" class="w-full bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 rounded-lg font-medium transition flex items-center justify-center gap-2 border border-blue-200">
                                    <i class="fas fa-camera"></i> Ambil Foto via Kamera
                                </button>
                                <div class="relative">
                                    <input type="file" id="foto" accept="image/*" class="w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Gunakan tombol kamera untuk mengambil foto langsung, atau pilih dari galeri.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pratinjau Foto</label>
                            <div id="foto-preview" class="w-full h-40 border border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-400 text-xs overflow-hidden bg-gray-50 relative group">
                                <span>Belum ada foto dipilih</span>
                                <button type="button" onclick="clearPhoto()" class="absolute top-2 right-2 bg-red-600 text-white w-8 h-8 rounded-full hidden group-hover:flex items-center justify-center shadow-lg transition hover:bg-red-700" id="btn-remove-photo">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i> Simpan Kartu Harian
                        </button>
                        <button type="button" onclick="resetForm()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="content-daftar" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-list text-blue-600"></i> Daftar Kunjungan Harian
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <input type="text" id="search-input" onkeyup="renderRecords()" placeholder="Cari nama usaha/bukti..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <input type="date" id="filter-date" onchange="renderRecords()" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <select id="filter-status" onchange="renderRecords()" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">Semua Status</option>
                            <option value="tertagih">Tertagih</option>
                            <option value="pending">Pending</option>
                            <option value="tidak_ditemui">Tidak Ditemui</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Petugas</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usaha/WP</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">No. Bukti</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">PBJT</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase no-print">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="records-table" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-400">Belum ada data kunjungan</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex items-center justify-between text-sm text-gray-500">
                    <span id="showing-info">Menampilkan 0 dari 0 kunjungan</span>
                    <div class="flex gap-2">
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-laporan" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-blue-600"></i> Filter Laporan Harian
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                        <input type="date" id="laporan-dari" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                        <input type="date" id="laporan-sampai" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Petugas</label>
                        <input type="text" id="laporan-petugas" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Semua petugas">
                    </div>
                    <div class="flex items-end">
                        <button onclick="generateReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center gap-2">
                            <i class="fas fa-filter"></i> Generate Laporan
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6" id="report-result">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Rekap Kunjungan & Penagihan</h3>
                    <div class="text-right print-only">
                        <p class="text-sm text-gray-500">Dicetak pada: <span id="print-date"></span></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Total DPP</p>
                        <p class="text-xl font-bold text-blue-700" id="report-dpp">Rp 0</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Total PBJT</p>
                        <p class="text-xl font-bold text-green-700" id="report-pbjt">Rp 0</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Jumlah Kunjungan</p>
                        <p class="text-xl font-bold text-purple-700" id="report-count">0</p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">Outstanding</p>
                        <p class="text-xl font-bold text-orange-700" id="report-outstanding">Rp 0</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-3">Ringkasan Status</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="report-by-status"></div>
                </div>

                <div class="border-t pt-4">
                    <h4 class="font-medium text-gray-700 mb-3">Detail Kunjungan Periode Ini</h4>
                    <div class="overflow-x-auto max-h-64 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left">Tanggal</th>
                                    <th class="px-3 py-2 text-left">Petugas</th>
                                    <th class="px-3 py-2 text-left">Usaha/WP</th>
                                    <th class="px-3 py-2 text-right">PBJT</th>
                                    <th class="px-3 py-2 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="report-details" class="divide-y">
                                <tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">Pilih periode untuk melihat laporan</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-wajib-pajak" class="tab-content hidden">
            <div class="max-w-5xl mx-auto space-y-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-building text-blue-600"></i> Data Wajib Pajak (WP)
                            </h2>
                            <p class="text-sm text-gray-500 mt-1">Kelola daftar wajib pajak terdaftar untuk memudahkan input kartu harian.</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="showTab('input')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                                <i class="fas fa-plus-circle"></i> Input Kartu Harian
                            </button>
                            <button onclick="showTab('pengaturan')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                                <i class="fas fa-cog"></i> Pengaturan
                            </button>
                        </div>
                    </div>

                    <form id="wp-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Usaha/WP *</label>
                            <input type="text" id="wp-nama" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nama usaha">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NPWPD/NPWP</label>
                            <input type="text" id="wp-npwp" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nomor NPWPD/NPWP">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Wilayah/Area</label>
                            <input type="text" id="wp-wilayah" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Contoh: Kecamatan X">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                            <input type="text" id="wp-alamat" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Alamat usaha">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kontak</label>
                            <input type="text" id="wp-kontak" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="No. telepon">
                        </div>
                        <div class="lg:col-span-3 flex justify-end">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                                <i class="fas fa-plus-circle"></i> Simpan Wajib Pajak
                            </button>
                        </div>
                    </form>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left">Nama Usaha/WP</th>
                                    <th class="px-3 py-2 text-left">NPWPD/NPWP</th>
                                    <th class="px-3 py-2 text-left">Wilayah</th>
                                    <th class="px-3 py-2 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="wp-table" class="divide-y"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">Data WP akan otomatis muncul di form input kartu harian.</p>
                </div>

                <div class="bg-blue-50 rounded-xl p-6">
                    <div class="flex items-start gap-3">
                        <div class="bg-blue-100 text-blue-600 rounded-full w-10 h-10 flex items-center justify-center">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">Tips Pengelolaan WP</p>
                            <p class="text-sm text-gray-600">Gunakan data WP agar petugas hanya memilih daftar yang tersedia saat input kartu harian. Data NPWPD/NPWP dan wilayah otomatis terisi.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-pengaturan" class="tab-content hidden">
            <div class="max-w-4xl mx-auto space-y-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-id-card text-blue-600"></i> Profil Petugas Pemungut
                    </h2>
                    <form id="collector-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Instansi *</label>
                                <input type="text" id="instansi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Petugas *</label>
                                <input type="text" id="nama-petugas" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Wilayah Tugas</label>
                                <input type="text" id="wilayah-tugas" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kontak</label>
                                <input type="text" id="kontak" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                            <i class="fas fa-save"></i> Simpan Profil
                        </button>
                    </form>
                </div>

                <div id="user-section" class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-users-cog text-blue-600"></i> Pengaturan User
                    </h2>
                    <form id="user-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama User *</label>
                            <input type="text" id="user-nama" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nama petugas">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                            <input type="text" id="user-username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="contoh: petugas">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                            <input type="text" id="user-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="password">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Peran</label>
                            <select id="user-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="Petugas">Petugas</option>
                                <option value="Koordinator">Koordinator</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="md:col-span-4 flex justify-end">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                                <i class="fas fa-user-plus"></i> Tambah User
                            </button>
                        </div>
                    </form>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left">Nama</th>
                                    <th class="px-3 py-2 text-left">Username</th>
                                    <th class="px-3 py-2 text-left">Peran</th>
                                    <th class="px-3 py-2 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="user-table" class="divide-y"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">User ini digunakan untuk login aplikasi. Simpan data di perangkat.</p>
                </div>

                <div id="petugas-section" class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-user-tie text-blue-600"></i> Data Petugas Lapangan
                    </h2>
                    <form id="petugas-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Petugas *</label>
                            <input type="text" id="petugas-nama" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nama petugas">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NIP / ID</label>
                            <input type="text" id="petugas-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nomor identitas">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Wilayah Tugas</label>
                            <input type="text" id="petugas-wilayah" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Wilayah tugas">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kontak</label>
                            <input type="text" id="petugas-kontak" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nomor telepon">
                        </div>
                        <div class="lg:col-span-4 flex justify-end">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                                <i class="fas fa-user-plus"></i> Simpan Petugas
                            </button>
                        </div>
                    </form>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left">Nama Petugas</th>
                                    <th class="px-3 py-2 text-left">NIP/ID</th>
                                    <th class="px-3 py-2 text-left">Wilayah</th>
                                    <th class="px-3 py-2 text-left">Kontak</th>
                                    <th class="px-3 py-2 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="petugas-table" class="divide-y"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">Data petugas akan muncul sebagai saran pada input kartu harian.</p>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-sliders-h text-blue-600"></i> Pengaturan Tarif
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tarif Standar (%)</label>
                            <input type="number" id="tarif-standar" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="10" step="0.1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tarif Khusus 1 (%)</label>
                            <input type="number" id="tarif-khusus1" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="7.5" step="0.1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tarif Khusus 2 (%)</label>
                            <input type="number" id="tarif-khusus2" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="5" step="0.1">
                        </div>
                    </div>
                    <button onclick="saveTarifSettings()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                        <i class="fas fa-save"></i> Simpan Tarif
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-database text-blue-600"></i> Manajemen Data
                    </h2>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="backupData()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-download"></i> Backup Data
                        </button>
                        <label class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition flex items-center gap-2 cursor-pointer">
                            <i class="fas fa-upload"></i> Restore Data
                            <input type="file" accept=".json" onchange="restoreData(event)" class="hidden">
                        </label>
                        <button onclick="confirmClearData()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-trash"></i> Hapus Semua Data
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-cloud text-blue-600"></i> Penyimpanan Database Online
                    </h2>
                    <form id="cloud-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Endpoint API</label>
                                <input type="url" id="cloud-endpoint" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="https://api.example.com/pbjt">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">API Key / Token</label>
                                <input type="text" id="cloud-key" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Masukkan API key">
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-blue-50 rounded-lg p-4">
                            <div>
                                <p class="font-medium text-gray-800">Sinkronisasi Online</p>
                                <p class="text-sm text-gray-600">Simpan data ke server setiap perubahan</p>
                            </div>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="cloud-enabled" class="sr-only peer">
                                <div class="w-12 h-6 bg-gray-300 rounded-full peer peer-checked:bg-blue-600 relative transition">
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-6"></div>
                                </div>
                            </label>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition flex items-center gap-2">
                                <i class="fas fa-save"></i> Simpan Pengaturan
                            </button>
                            <button type="button" onclick="syncToCloud()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition flex items-center gap-2">
                                <i class="fas fa-cloud-upload-alt"></i> Sync Sekarang
                            </button>
                            <button type="button" onclick="pullFromCloud()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition flex items-center gap-2">
                                <i class="fas fa-cloud-download-alt"></i> Ambil dari Cloud
                            </button>
                        </div>
                        <p class="text-xs text-gray-500">Gunakan endpoint API yang mendukung penyimpanan JSON (GET/POST/PUT). Contoh: Firebase, Supabase, atau server internal.</p>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md mx-4">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Konfirmasi Hapus</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus data kunjungan ini?</p>
            <div class="flex gap-3 justify-end">
                <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">Batal</button>
                <button onclick="confirmDelete()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Modal Kamera -->
    <div id="camera-modal" class="fixed inset-0 bg-black z-[100] hidden flex-col">
        <div class="flex items-center justify-between p-4 text-white bg-black bg-opacity-50">
            <h3 class="font-bold">Ambil Foto Penagihan</h3>
            <button onclick="closeCamera()" class="text-2xl"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 relative flex items-center justify-center bg-black">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <canvas id="canvas" class="hidden"></canvas>
            
            <!-- Overlay Guide -->
            <div class="absolute inset-0 border-2 border-white border-opacity-30 pointer-events-none flex items-center justify-center">
                <div class="w-64 h-64 border-2 border-dashed border-white border-opacity-50 rounded-lg"></div>
            </div>
        </div>
        <div class="p-8 bg-black flex justify-center items-center gap-8">
            <button onclick="takePhoto()" class="w-20 h-20 bg-white rounded-full border-4 border-gray-400 flex items-center justify-center active:scale-95 transition">
                <div class="w-16 h-16 bg-red-600 rounded-full border-2 border-white"></div>
            </button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Data berhasil disimpan</span>
    </div>

    <div class="print-only hidden">
        <div class="text-center mb-6">
            <h1 class="text-xl font-bold">KARTU KONTROL HARIAN PBJT</h1>
            <h2 class="text-lg font-semibold">Pemungutan & Penagihan Pajak Makanan/Minuman</h2>
            <p id="print-instansi" class="text-sm mt-2"></p>
            <p id="print-petugas" class="text-sm"></p>
        </div>
    </div>
    </div>

    <script>
        let dailyRecords = JSON.parse(localStorage.getItem('pbjt_daily_records')) || [];
        let collectorProfile = JSON.parse(localStorage.getItem('pbjt_collector_profile')) || {
            instansi: 'UPT Pajak Daerah',
            petugas: 'Petugas 1',
            wilayah: 'Wilayah A',
            kontak: ''
        };
        let tarifSettings = JSON.parse(localStorage.getItem('pbjt_tarif_settings')) || {
            standar: 10,
            khusus1: 7.5,
            khusus2: 5
        };
        let cloudSettings = JSON.parse(localStorage.getItem('pbjt_cloud_settings')) || {
            endpoint: '',
            apiKey: '',
            enabled: false
        };
        let appUsers = JSON.parse(localStorage.getItem('pbjt_app_users')) || [
            { id: 'admin-default', name: 'Admin Utama', username: 'admin', password: 'admin123', role: 'Admin' },
            { id: 'petugas-default', name: 'Petugas Lapangan', username: 'petugas', password: 'pbjt123', role: 'Petugas' }
        ];
        let wajibPajakList = JSON.parse(localStorage.getItem('pbjt_wajib_pajak')) || [];
        let petugasList = JSON.parse(localStorage.getItem('pbjt_petugas_list')) || [];
        let deleteId = null;
        let deleteUserId = null;
        let deleteWpId = null;
        let currentUser = JSON.parse(localStorage.getItem('pbjt_current_user')) || null;

        document.addEventListener('DOMContentLoaded', function() {
            initAuth();
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            if (!isAuthenticated()) {
                return;
            }
            loadCollectorProfile();
            loadTarifSettings();
            loadCloudSettings();
            loadUsers();
            loadPetugas();
            loadWajibPajak();
            updateDashboard();
            renderRecords();
            setDefaultDates();

            document.getElementById('tanggal').valueAsDate = new Date();
            document.getElementById('dpp').addEventListener('input', calculatePBJT);
            document.getElementById('tarif').addEventListener('change', calculatePBJT);

            const fotoInput = document.getElementById('foto');
            if (fotoInput) {
                fotoInput.addEventListener('change', handleFotoChange);
            }

            const wpSelect = document.getElementById('wp-select');
            if (wpSelect) {
                wpSelect.addEventListener('change', handleWpSelect);
            }

            document.getElementById('daily-form').addEventListener('submit', saveRecord);
            document.getElementById('collector-form').addEventListener('submit', saveCollectorProfile);
            document.getElementById('cloud-form').addEventListener('submit', saveCloudSettings);
            document.getElementById('user-form').addEventListener('submit', saveUser);
            document.getElementById('petugas-form').addEventListener('submit', savePetugas);
            document.getElementById('wp-form').addEventListener('submit', saveWajibPajak);
        });

        function initAuth() {
            toggleAuthUI(isAuthenticated());
        }

        function isAuthenticated() {
            return localStorage.getItem('pbjt_logged_in') === 'true';
        }

        function isAdmin() {
            return currentUser && currentUser.role === 'Admin';
        }

        function toggleAuthUI(loggedIn) {
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');
            if (loggedIn) {
                loginScreen.classList.add('hidden');
                appContent.classList.remove('hidden');
                applyRoleAccess();
            } else {
                loginScreen.classList.remove('hidden');
                appContent.classList.add('hidden');
            }
        }

        function applyRoleAccess() {
            const tabPengaturan = document.getElementById('tab-pengaturan');
            if (!tabPengaturan) return;
            if (isAdmin()) {
                tabPengaturan.classList.remove('hidden');
            } else {
                tabPengaturan.classList.add('hidden');
                if (document.getElementById('content-pengaturan') && !document.getElementById('content-pengaturan').classList.contains('hidden')) {
                    showTab('dashboard');
                }
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const error = document.getElementById('login-error');

            const foundUser = appUsers.find(u => u.username === username && u.password === password);
            if (foundUser) {
                localStorage.setItem('pbjt_logged_in', 'true');
                localStorage.setItem('pbjt_current_user', JSON.stringify(foundUser));
                currentUser = foundUser;
                error.classList.add('hidden');
                toggleAuthUI(true);
                loadCollectorProfile();
                loadTarifSettings();
                loadCloudSettings();
                loadUsers();
                loadPetugas();
                loadWajibPajak();
                updateDashboard();
                renderRecords();
                setDefaultDates();
                document.getElementById('tanggal').valueAsDate = new Date();
                showToast('Login berhasil');
            } else {
                error.classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('pbjt_logged_in');
            localStorage.removeItem('pbjt_current_user');
            currentUser = null;
            document.getElementById('login-form').reset();
            document.getElementById('login-error').classList.add('hidden');
            toggleAuthUI(false);
        }

        function showTab(tabName) {
            if (tabName === 'pengaturan' && !isAdmin()) {
                showToast('Menu pengaturan hanya untuk admin');
                return;
            }
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-gray-600');
            });
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-600');

            if (tabName === 'laporan') {
                document.getElementById('print-date').textContent = new Date().toLocaleDateString('id-ID', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }
        }

        function loadCollectorProfile() {
            document.getElementById('instansi').value = collectorProfile.instansi;
            document.getElementById('nama-petugas').value = collectorProfile.petugas;
            document.getElementById('wilayah-tugas').value = collectorProfile.wilayah;
            document.getElementById('kontak').value = collectorProfile.kontak;
            updateCollectorInfo();
        }

        function saveCollectorProfile(e) {
            e.preventDefault();
            collectorProfile = {
                instansi: document.getElementById('instansi').value,
                petugas: document.getElementById('nama-petugas').value,
                wilayah: document.getElementById('wilayah-tugas').value,
                kontak: document.getElementById('kontak').value
            };
            localStorage.setItem('pbjt_collector_profile', JSON.stringify(collectorProfile));
            updateCollectorInfo();
            showToast('Profil petugas berhasil disimpan');
            triggerCloudSync();
        }

        function updateCollectorInfo() {
            const info = document.getElementById('collector-info');
            info.innerHTML = `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500">Instansi</p>
                    <p class="font-semibold text-gray-800">${collectorProfile.instansi}</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500">Petugas Utama</p>
                    <p class="font-semibold text-gray-800">${collectorProfile.petugas}</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500">Wilayah</p>
                    <p class="font-semibold text-gray-800">${collectorProfile.wilayah || '-'}</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500">Kontak</p>
                    <p class="font-semibold text-gray-800">${collectorProfile.kontak || '-'}</p>
                </div>
            `;
            document.getElementById('print-instansi').textContent = collectorProfile.instansi;
            document.getElementById('print-petugas').textContent = `Petugas: ${collectorProfile.petugas}`;
        }

        function loadTarifSettings() {
            document.getElementById('tarif-standar').value = tarifSettings.standar;
            document.getElementById('tarif-khusus1').value = tarifSettings.khusus1;
            document.getElementById('tarif-khusus2').value = tarifSettings.khusus2;

            const tarifSelect = document.getElementById('tarif');
            tarifSelect.innerHTML = `
                <option value="${tarifSettings.standar}">${tarifSettings.standar}% (Standar)</option>
                <option value="${tarifSettings.khusus1}">${tarifSettings.khusus1}% (Khusus 1)</option>
                <option value="${tarifSettings.khusus2}">${tarifSettings.khusus2}% (Khusus 2)</option>
                <option value="0">0% (Dikecualikan)</option>
            `;
        }

        function saveTarifSettings() {
            tarifSettings = {
                standar: parseFloat(document.getElementById('tarif-standar').value),
                khusus1: parseFloat(document.getElementById('tarif-khusus1').value),
                khusus2: parseFloat(document.getElementById('tarif-khusus2').value)
            };
            localStorage.setItem('pbjt_tarif_settings', JSON.stringify(tarifSettings));
            loadTarifSettings();
            showToast('Tarif berhasil disimpan');
            triggerCloudSync();
        }

        function loadCloudSettings() {
            document.getElementById('cloud-endpoint').value = cloudSettings.endpoint || '';
            document.getElementById('cloud-key').value = cloudSettings.apiKey || '';
            document.getElementById('cloud-enabled').checked = !!cloudSettings.enabled;
        }

        function saveCloudSettings(e) {
            e.preventDefault();
            cloudSettings = {
                endpoint: document.getElementById('cloud-endpoint').value.trim(),
                apiKey: document.getElementById('cloud-key').value.trim(),
                enabled: document.getElementById('cloud-enabled').checked
            };
            localStorage.setItem('pbjt_cloud_settings', JSON.stringify(cloudSettings));
            showToast('Pengaturan cloud disimpan');
        }

        function getCloudHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (cloudSettings.apiKey) {
                headers['Authorization'] = `Bearer ${cloudSettings.apiKey}`;
            }
            return headers;
        }

        async function syncToCloud() {
            if (!cloudSettings.endpoint) {
                alert('Endpoint API belum diisi');
                return;
            }
            const payload = {
                dailyRecords: dailyRecords,
                collectorProfile: collectorProfile,
                tarifSettings: tarifSettings,
                updatedAt: new Date().toISOString()
            };
            try {
                const response = await fetch(cloudSettings.endpoint, {
                    method: 'PUT',
                    headers: getCloudHeaders(),
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('Gagal sync');
                showToast('Data berhasil disinkron ke cloud');
            } catch (error) {
                alert('Gagal sinkron ke cloud. Periksa endpoint/API key.');
            }
        }

        async function pullFromCloud() {
            if (!cloudSettings.endpoint) {
                alert('Endpoint API belum diisi');
                return;
            }
            try {
                const response = await fetch(cloudSettings.endpoint, {
                    method: 'GET',
                    headers: getCloudHeaders()
                });
                if (!response.ok) throw new Error('Gagal mengambil data');
                const data = await response.json();
                if (data.dailyRecords) {
                    dailyRecords = data.dailyRecords;
                    localStorage.setItem('pbjt_daily_records', JSON.stringify(dailyRecords));
                }
                if (data.collectorProfile) {
                    collectorProfile = data.collectorProfile;
                    localStorage.setItem('pbjt_collector_profile', JSON.stringify(collectorProfile));
                    loadCollectorProfile();
                }
                if (data.tarifSettings) {
                    tarifSettings = data.tarifSettings;
                    localStorage.setItem('pbjt_tarif_settings', JSON.stringify(tarifSettings));
                    loadTarifSettings();
                }
                updateDashboard();
                renderRecords();
                showToast('Data cloud berhasil diambil');
            } catch (error) {
                alert('Gagal mengambil data dari cloud.');
            }
        }

        function calculatePBJT() {
            const dpp = parseFloat(document.getElementById('dpp').value) || 0;
            const tarif = parseFloat(document.getElementById('tarif').value) || 0;
            const pbjt = dpp * (tarif / 100);
            document.getElementById('pbjt').value = formatRupiah(pbjt);
        }

        let cameraStream = null;

        async function openCamera() {
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('video');
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                video.srcObject = cameraStream;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera.");
            }
        }

        function closeCamera() {
            const modal = document.getElementById('camera-modal');
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
        }

        function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('foto-preview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg');
            
            renderPreviewImage(imageData);
            
            // Clear file input if photo is taken via camera
            document.getElementById('foto').value = '';
            
            closeCamera();
            showToast('Foto berhasil diambil');
        }

        function renderPreviewImage(src) {
            const preview = document.getElementById('foto-preview');
            preview.innerHTML = `
                <img src="${src}" class="object-cover w-full h-full">
                <button type="button" onclick="clearPhoto()" class="absolute top-2 right-2 bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg transition hover:bg-red-700">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            preview.classList.remove('text-gray-400');
            preview.dataset.image = src;
        }

        function clearPhoto() {
            const preview = document.getElementById('foto-preview');
            const fileInput = document.getElementById('foto');
            preview.innerHTML = '<span>Belum ada foto dipilih</span>';
            preview.classList.add('text-gray-400');
            delete preview.dataset.image;
            fileInput.value = '';
        }

        function handleFotoChange(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('foto-preview');
            if (!file) {
                if (!preview.dataset.image) {
                    preview.innerHTML = 'Belum ada foto dipilih';
                    preview.classList.add('text-gray-400');
                }
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'object-cover w-full h-full';
                preview.innerHTML = '';
                preview.classList.remove('text-gray-400');
                preview.appendChild(img);
                preview.dataset.image = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveRecord(e) {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const dpp = parseFloat(document.getElementById('dpp').value) || 0;
            const tarif = parseFloat(document.getElementById('tarif').value) || 0;
            const wpValue = document.getElementById('wp-select').value;

            const preview = document.getElementById('foto-preview');
            const fotoData = preview && preview.dataset.image ? preview.dataset.image : (editId ? (dailyRecords.find(r => r.id === editId)?.foto || null) : null);

            const record = {
                id: editId || Date.now().toString(),
                tanggal: document.getElementById('tanggal').value,
                petugas: document.getElementById('petugas').value,
                shift: document.getElementById('shift').value,
                wilayah: document.getElementById('wilayah').value,
                namaUsaha: document.getElementById('nama-usaha').value,
                npwp: document.getElementById('npwp').value,
                wpId: wpValue || null,
                noBukti: document.getElementById('no-bukti').value,
                jenis: document.getElementById('jenis').value,
                dpp: dpp,
                tarif: tarif,
                pbjt: dpp * (tarif / 100),
                metode: document.getElementById('metode').value,
                status: document.getElementById('status').value,
                keterangan: document.getElementById('keterangan').value,
                foto: fotoData,
                createdAt: editId ? dailyRecords.find(r => r.id === editId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (editId) {
                const index = dailyRecords.findIndex(r => r.id === editId);
                dailyRecords[index] = record;
                showToast('Data kunjungan diperbarui');
            } else {
                dailyRecords.push(record);
                showToast('Data kunjungan disimpan');
            }

            localStorage.setItem('pbjt_daily_records', JSON.stringify(dailyRecords));
            resetForm();
            updateDashboard();
            renderRecords();
            triggerCloudSync();
        }

        function editRecord(id) {
            const record = dailyRecords.find(r => r.id === id);
            if (!record) return;

            document.getElementById('edit-id').value = record.id;
            document.getElementById('tanggal').value = record.tanggal;
            document.getElementById('petugas').value = record.petugas;
            document.getElementById('shift').value = record.shift;
            document.getElementById('wilayah').value = record.wilayah;
            document.getElementById('nama-usaha').value = record.namaUsaha;
            document.getElementById('npwp').value = record.npwp || '';
            document.getElementById('no-bukti').value = record.noBukti;
            document.getElementById('jenis').value = record.jenis;
            document.getElementById('dpp').value = record.dpp;
            document.getElementById('tarif').value = record.tarif;
            document.getElementById('pbjt').value = formatRupiah(record.pbjt);
            document.getElementById('metode').value = record.metode;
            document.getElementById('status').value = record.status;
            document.getElementById('keterangan').value = record.keterangan || '';
            document.getElementById('wp-select').value = record.wpId || '';

            const preview = document.getElementById('foto-preview');
            const fotoInput = document.getElementById('foto');
            if (fotoInput) fotoInput.value = '';
            if (preview) {
                if (record.foto) {
                    renderPreviewImage(record.foto);
                } else {
                    clearPhoto();
                }
            }

            showTab('input');
            window.scrollTo(0, 0);
        }

        function deleteRecord(id) {
            deleteId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('delete-modal').classList.add('flex');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            document.getElementById('delete-modal').classList.remove('flex');
            deleteId = null;
        }

        function confirmDelete() {
            if (deleteId) {
                dailyRecords = dailyRecords.filter(r => r.id !== deleteId);
                localStorage.setItem('pbjt_daily_records', JSON.stringify(dailyRecords));
                updateDashboard();
                renderRecords();
                showToast('Data kunjungan dihapus');
            }
            closeDeleteModal();
        }

        function resetForm() {
            document.getElementById('daily-form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('tanggal').valueAsDate = new Date();
            document.getElementById('pbjt').value = 'Rp 0';
            document.getElementById('wp-select').value = '';
            clearPhoto();
        }

        function renderRecords() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filterDate = document.getElementById('filter-date').value;
            const filterStatus = document.getElementById('filter-status').value;

            let filtered = dailyRecords.filter(r => {
                const matchesSearch = r.namaUsaha.toLowerCase().includes(searchTerm) || r.noBukti.toLowerCase().includes(searchTerm);
                const matchesDate = !filterDate || r.tanggal === filterDate;
                const matchesStatus = !filterStatus || r.status === filterStatus;
                return matchesSearch && matchesDate && matchesStatus;
            });

            filtered.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            const tbody = document.getElementById('records-table');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-400">Tidak ada data kunjungan</td></tr>';
            } else {
                tbody.innerHTML = filtered.map(r => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">${formatDate(r.tanggal)}</td>
                        <td class="px-4 py-3 text-sm">${r.petugas}</td>
                        <td class="px-4 py-3 text-sm">${r.namaUsaha}</td>
                        <td class="px-4 py-3 text-sm">${r.noBukti}</td>
                        <td class="px-4 py-3 text-sm text-right font-medium text-green-600">${formatRupiah(r.pbjt)}</td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex items-center justify-center gap-1">
                                <span class="px-2 py-1 rounded-full text-xs ${getStatusColor(r.status)}">${getStatusLabel(r.status)}</span>
                                ${r.foto ? '<i class="fas fa-camera text-blue-500 text-xs" title="Foto pelaksanaan tersedia"></i>' : ''}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center no-print">
                            <button onclick="editRecord('${r.id}')" class="text-blue-600 hover:text-blue-800 mx-1" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteRecord('${r.id}')" class="text-red-600 hover:text-red-800 mx-1" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            document.getElementById('showing-info').textContent = `Menampilkan ${filtered.length} dari ${dailyRecords.length} kunjungan`;
        }

        function updateDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todayRecords = dailyRecords.filter(r => r.tanggal === todayStr);
            const totalToday = todayRecords.reduce((sum, r) => sum + r.pbjt, 0);
            const totalPaid = todayRecords.filter(r => r.status === 'tertagih').reduce((sum, r) => sum + r.pbjt, 0);
            const outstanding = todayRecords.filter(r => r.status !== 'tertagih').reduce((sum, r) => sum + r.pbjt, 0);

            document.getElementById('summary-today').textContent = formatRupiah(totalToday);
            document.getElementById('summary-paid').textContent = formatRupiah(totalPaid);
            document.getElementById('summary-visits').textContent = todayRecords.length;
            document.getElementById('summary-outstanding').textContent = formatRupiah(outstanding);
            const petugasCount = petugasList && petugasList.length ? petugasList.length : (appUsers ? appUsers.length : 0);
            document.getElementById('summary-petugas').textContent = petugasCount;

            renderChart();
            renderRecent();
        }

        function renderChart() {
            const container = document.getElementById('chart-container');
            const labelsContainer = document.getElementById('chart-labels');
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                days.push(d);
            }

            const dailyData = days.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                return dailyRecords.filter(r => r.tanggal === dateStr).reduce((sum, r) => sum + r.pbjt, 0);
            });

            const maxValue = Math.max(...dailyData, 1);

            container.innerHTML = dailyData.map((value, index) => {
                const height = (value / maxValue) * 100;
                const isToday = index === 6;
                return `
                    <div class="flex flex-col items-center flex-1">
                        <div class="w-full max-w-8 ${isToday ? 'bg-blue-500' : 'bg-blue-300'} rounded-t" style="height: ${Math.max(height, 2)}%" title="${formatDate(days[index])}: ${formatRupiah(value)}"></div>
                    </div>
                `;
            }).join('');

            labelsContainer.innerHTML = days.map(d => `<span>${d.getDate()}/${d.getMonth() + 1}</span>`).join('');
        }

        function renderRecent() {
            const container = document.getElementById('recent-visits');
            const recent = [...dailyRecords].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada data kunjungan</p>';
                return;
            }

            container.innerHTML = recent.map(r => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 p-2 rounded-full">
                            <i class="fas fa-store text-blue-600 text-sm"></i>
                        </div>
                        <div>
                            <p class="font-medium text-sm">${r.namaUsaha}</p>
                            <p class="text-xs text-gray-500">${formatDate(r.tanggal)}  ${r.petugas}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-medium text-green-600">${formatRupiah(r.pbjt)}</p>
                        <div class="flex items-center justify-end gap-1">
                            <span class="text-xs px-2 py-0.5 rounded-full ${getStatusColor(r.status)}">${getStatusLabel(r.status)}</span>
                            ${r.foto ? '<i class="fas fa-camera text-blue-500 text-[10px]" title="Foto pelaksanaan tersedia"></i>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function setDefaultDates() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('laporan-dari').valueAsDate = firstDay;
            document.getElementById('laporan-sampai').valueAsDate = now;
        }

        function generateReport() {
            const dari = document.getElementById('laporan-dari').value;
            const sampai = document.getElementById('laporan-sampai').value;
            const petugas = document.getElementById('laporan-petugas').value.toLowerCase();

            let filtered = dailyRecords.filter(r => {
                const rDate = new Date(r.tanggal);
                const matchesDate = rDate >= new Date(dari) && rDate <= new Date(sampai);
                const matchesPetugas = !petugas || r.petugas.toLowerCase().includes(petugas);
                return matchesDate && matchesPetugas;
            });

            const totalDPP = filtered.reduce((sum, r) => sum + r.dpp, 0);
            const totalPbjt = filtered.reduce((sum, r) => sum + r.pbjt, 0);
            const outstanding = filtered.filter(r => r.status !== 'tertagih').reduce((sum, r) => sum + r.pbjt, 0);

            document.getElementById('report-dpp').textContent = formatRupiah(totalDPP);
            document.getElementById('report-pbjt').textContent = formatRupiah(totalPbjt);
            document.getElementById('report-count').textContent = filtered.length;
            document.getElementById('report-outstanding').textContent = formatRupiah(outstanding);

            const byStatus = {
                tertagih: { count: 0, total: 0, label: 'Tertagih' },
                pending: { count: 0, total: 0, label: 'Pending' },
                tidak_ditemui: { count: 0, total: 0, label: 'Tidak Ditemui' }
            };

            filtered.forEach(r => {
                if (byStatus[r.status]) {
                    byStatus[r.status].count++;
                    byStatus[r.status].total += r.pbjt;
                }
            });

            document.getElementById('report-by-status').innerHTML = Object.values(byStatus).map(val => `
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600">${val.label}</p>
                    <p class="text-lg font-bold text-gray-800">${formatRupiah(val.total)}</p>
                    <p class="text-xs text-gray-500">${val.count} kunjungan</p>
                </div>
            `).join('');

            const detailsBody = document.getElementById('report-details');
            if (filtered.length === 0) {
                detailsBody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">Tidak ada data untuk periode ini</td></tr>';
            } else {
                detailsBody.innerHTML = filtered.map(r => `
                    <tr>
                        <td class="px-3 py-2">${formatDate(r.tanggal)}</td>
                        <td class="px-3 py-2">${r.petugas}</td>
                        <td class="px-3 py-2">${r.namaUsaha}</td>
                        <td class="px-3 py-2 text-right">${formatRupiah(r.pbjt)}</td>
                        <td class="px-3 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-xs ${getStatusColor(r.status)}">${getStatusLabel(r.status)}</span>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function formatRupiah(num) {
            return 'Rp ' + num.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatDate(dateInput) {
            const date = dateInput instanceof Date ? dateInput : new Date(dateInput);
            return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function getStatusLabel(status) {
            const labels = {
                tertagih: 'Tertagih',
                pending: 'Pending',
                tidak_ditemui: 'Tidak Ditemui'
            };
            return labels[status] || status;
        }

        function getStatusColor(status) {
            const colors = {
                tertagih: 'bg-green-100 text-green-700',
                pending: 'bg-yellow-100 text-yellow-700',
                tidak_ditemui: 'bg-red-100 text-red-700'
            };
            return colors[status] || 'bg-gray-100 text-gray-700';
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function exportData() {
            const data = {
                dailyRecords: dailyRecords,
                collectorProfile: collectorProfile,
                tarifSettings: tarifSettings,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pbjt_kartu_harian_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data berhasil di-export');
        }

        function backupData() {
            exportData();
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.dailyRecords) {
                        dailyRecords = data.dailyRecords;
                        localStorage.setItem('pbjt_daily_records', JSON.stringify(dailyRecords));
                    }
                    if (data.collectorProfile) {
                        collectorProfile = data.collectorProfile;
                        localStorage.setItem('pbjt_collector_profile', JSON.stringify(collectorProfile));
                        loadCollectorProfile();
                    }
                    if (data.tarifSettings) {
                        tarifSettings = data.tarifSettings;
                        localStorage.setItem('pbjt_tarif_settings', JSON.stringify(tarifSettings));
                        loadTarifSettings();
                    }
                    updateDashboard();
                    renderRecords();
                    showToast('Data berhasil di-restore');
                } catch (error) {
                    alert('File tidak valid atau rusak');
                }
            };
            reader.readAsText(file);
        }

        function exportToExcel() {
            let csv = 'Tanggal,Petugas,Wilayah,Usaha/WP,NPWP,No Bukti,Jenis,DPP,Tarif,PBJT,Metode,Status,Keterangan\n';
            dailyRecords.forEach(r => {
                csv += `"${r.tanggal}","${r.petugas}","${r.wilayah}","${r.namaUsaha}","${r.npwp || ''}","${r.noBukti}","${r.jenis}",${r.dpp},${r.tarif}%,${r.pbjt},"${r.metode}","${r.status}","${r.keterangan || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kartu_harian_pbjt_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data berhasil di-export ke Excel');
        }

        function confirmClearData() {
            if (confirm('Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) {
                if (confirm('Konfirmasi sekali lagi - semua data kunjungan akan dihapus permanen!')) {
                    dailyRecords = [];
                    localStorage.removeItem('pbjt_daily_records');
                    updateDashboard();
                    renderRecords();
                    showToast('Semua data berhasil dihapus');
                    triggerCloudSync();
                }
            }
        }

        function triggerCloudSync() {
            if (cloudSettings.enabled) {
                syncToCloud();
            }
        }

        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function loadUsers() {
            renderUserTable();
        }

        function saveUser(e) {
            e.preventDefault();
            const name = document.getElementById('user-nama').value.trim();
            const username = document.getElementById('user-username').value.trim();
            const password = document.getElementById('user-password').value.trim();
            const role = document.getElementById('user-role').value;

            if (appUsers.some(u => u.username === username)) {
                alert('Username sudah terdaftar.');
                return;
            }

            appUsers.push({ id: Date.now().toString(), name, username, password, role });
            localStorage.setItem('pbjt_app_users', JSON.stringify(appUsers));
            document.getElementById('user-form').reset();
            renderUserTable();
            updateDashboard();
            showToast('User berhasil ditambahkan');
        }

        function renderUserTable() {
            const tbody = document.getElementById('user-table');
            if (!tbody) return;
            if (appUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-gray-400">Belum ada user</td></tr>';
                return;
            }
            tbody.innerHTML = appUsers.map(user => `
                <tr>
                    <td class="px-3 py-2">${user.name}</td>
                    <td class="px-3 py-2">${user.username}</td>
                    <td class="px-3 py-2">${user.role}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="removeUser('${user.id}')" class="text-red-600 hover:text-red-800" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function removeUser(id) {
            if (!confirm('Hapus user ini?')) return;
            appUsers = appUsers.filter(u => u.id !== id);
            if (appUsers.length === 0) {
                appUsers.push({ id: 'admin-default', name: 'Admin Utama', username: 'admin', password: 'admin123', role: 'Admin' });
                appUsers.push({ id: 'petugas-default', name: 'Petugas Lapangan', username: 'petugas', password: 'pbjt123', role: 'Petugas' });
            }
            localStorage.setItem('pbjt_app_users', JSON.stringify(appUsers));
            renderUserTable();
            updateDashboard();
            showToast('User dihapus');
        }

        function loadPetugas() {
            renderPetugasTable();
            populatePetugasList();
        }

        function savePetugas(e) {
            e.preventDefault();
            const petugas = {
                id: Date.now().toString(),
                nama: document.getElementById('petugas-nama').value.trim(),
                nip: document.getElementById('petugas-id').value.trim(),
                wilayah: document.getElementById('petugas-wilayah').value.trim(),
                kontak: document.getElementById('petugas-kontak').value.trim()
            };
            petugasList.push(petugas);
            localStorage.setItem('pbjt_petugas_list', JSON.stringify(petugasList));
            document.getElementById('petugas-form').reset();
            renderPetugasTable();
            populatePetugasList();
            updateDashboard();
            showToast('Data petugas disimpan');
        }

        function savePetugasQuick(e) {
            e.preventDefault();
            const petugas = {
                id: Date.now().toString(),
                nama: document.getElementById('petugas-quick-nama').value.trim(),
                nip: document.getElementById('petugas-quick-id').value.trim(),
                wilayah: document.getElementById('petugas-quick-wilayah').value.trim(),
                kontak: document.getElementById('petugas-quick-kontak').value.trim()
            };

            if (!petugas.nama) {
                alert('Nama petugas wajib diisi.');
                return;
            }

            petugasList.push(petugas);
            localStorage.setItem('pbjt_petugas_list', JSON.stringify(petugasList));
            document.getElementById('petugas-quick-form').reset();
            renderPetugasTable();
            populatePetugasList();
            updateDashboard();
            showToast('Petugas pemungut berhasil ditambahkan');
            triggerCloudSync();
        }

        function renderPetugasTable() {
            const tbody = document.getElementById('petugas-table');
            if (!tbody) return;
            if (petugasList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-gray-400">Belum ada data petugas</td></tr>';
                return;
            }
            tbody.innerHTML = petugasList.map(p => `
                <tr>
                    <td class="px-3 py-2">${p.nama}</td>
                    <td class="px-3 py-2">${p.nip || '-'}</td>
                    <td class="px-3 py-2">${p.wilayah || '-'}</td>
                    <td class="px-3 py-2">${p.kontak || '-'}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="editPetugas('${p.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removePetugas('${p.id}')" class="text-red-600 hover:text-red-800" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function editPetugas(id) {
            const petugas = petugasList.find(item => item.id === id);
            if (!petugas) return;
            document.getElementById('petugas-nama').value = petugas.nama;
            document.getElementById('petugas-id').value = petugas.nip || '';
            document.getElementById('petugas-wilayah').value = petugas.wilayah || '';
            document.getElementById('petugas-kontak').value = petugas.kontak || '';
            petugasList = petugasList.filter(item => item.id !== id);
            localStorage.setItem('pbjt_petugas_list', JSON.stringify(petugasList));
            renderPetugasTable();
            populatePetugasList();
        }

        function removePetugas(id) {
            if (!confirm('Hapus data petugas ini?')) return;
            petugasList = petugasList.filter(item => item.id !== id);
            localStorage.setItem('pbjt_petugas_list', JSON.stringify(petugasList));
            renderPetugasTable();
            populatePetugasList();
            updateDashboard();
            showToast('Data petugas dihapus');
        }

        function populatePetugasList() {
            const list = document.getElementById('petugas-list');
            if (!list) return;
            list.innerHTML = petugasList.map(p => `<option value="${p.nama}"></option>`).join('');
        }

        function loadWajibPajak() {
            renderWajibPajakTable();
            populateWpSelect();
        }

        function saveWajibPajak(e) {
            e.preventDefault();
            const wp = {
                id: Date.now().toString(),
                nama: document.getElementById('wp-nama').value.trim(),
                npwp: document.getElementById('wp-npwp').value.trim(),
                wilayah: document.getElementById('wp-wilayah').value.trim(),
                alamat: document.getElementById('wp-alamat').value.trim(),
                kontak: document.getElementById('wp-kontak').value.trim()
            };
            wajibPajakList.push(wp);
            localStorage.setItem('pbjt_wajib_pajak', JSON.stringify(wajibPajakList));
            document.getElementById('wp-form').reset();
            renderWajibPajakTable();
            populateWpSelect();
            showToast('Data wajib pajak disimpan');
        }

        function renderWajibPajakTable() {
            const tbody = document.getElementById('wp-table');
            if (!tbody) return;
            if (wajibPajakList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-gray-400">Belum ada data wajib pajak</td></tr>';
                return;
            }
            tbody.innerHTML = wajibPajakList.map(wp => `
                <tr>
                    <td class="px-3 py-2">${wp.nama}</td>
                    <td class="px-3 py-2">${wp.npwp || '-'}</td>
                    <td class="px-3 py-2">${wp.wilayah || '-'}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="editWajibPajak('${wp.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removeWajibPajak('${wp.id}')" class="text-red-600 hover:text-red-800" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function editWajibPajak(id) {
            const wp = wajibPajakList.find(item => item.id === id);
            if (!wp) return;
            document.getElementById('wp-nama').value = wp.nama;
            document.getElementById('wp-npwp').value = wp.npwp || '';
            document.getElementById('wp-wilayah').value = wp.wilayah || '';
            document.getElementById('wp-alamat').value = wp.alamat || '';
            document.getElementById('wp-kontak').value = wp.kontak || '';
            wajibPajakList = wajibPajakList.filter(item => item.id !== id);
            localStorage.setItem('pbjt_wajib_pajak', JSON.stringify(wajibPajakList));
            renderWajibPajakTable();
            populateWpSelect();
        }

        function removeWajibPajak(id) {
            if (!confirm('Hapus data wajib pajak ini?')) return;
            wajibPajakList = wajibPajakList.filter(item => item.id !== id);
            localStorage.setItem('pbjt_wajib_pajak', JSON.stringify(wajibPajakList));
            renderWajibPajakTable();
            populateWpSelect();
            showToast('Data wajib pajak dihapus');
        }

        function populateWpSelect() {
            const select = document.getElementById('wp-select');
            if (!select) return;
            select.innerHTML = '<option value="">Pilih Wajib Pajak (opsional)</option>' + wajibPajakList.map(wp => `
                <option value="${wp.id}">${wp.nama} ${wp.npwp ? `- ${wp.npwp}` : ''}</option>
            `).join('');
        }

        function handleWpSelect(e) {
            const id = e.target.value;
            if (!id) return;
            const wp = wajibPajakList.find(item => item.id === id);
            if (!wp) return;
            document.getElementById('nama-usaha').value = wp.nama;
            document.getElementById('npwp').value = wp.npwp || '';
            document.getElementById('wilayah').value = wp.wilayah || '';
        }
    </script>
</body>
</html>
